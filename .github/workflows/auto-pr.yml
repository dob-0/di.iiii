name: Auto PR dev→main

on:
  push:
    branches:
      - dev
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR from dev to main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const head = 'dev';
            const base = 'main';
            const title = 'Auto PR: dev → main';
            const body = [
              'Summary: New/cleared scenes are visible; skip server reload after clear;',
              'stronger grid and aligned camera; dev server auto-opens chosen path.',
              '',
              'Includes: default scene + camera updates, clear logic fixes, grid color/appearance,',
              'vite auto-open env, CI + release workflows.'
            ].join('\n');

            async function run() {
              try {
                const prs = await github.rest.pulls.list({
                  owner,
                  repo,
                  state: 'open',
                  head: `${owner}:${head}`,
                  base,
                });
                if (prs.data && prs.data.length > 0) {
                  core.info(`PR already exists: ${prs.data[0].html_url}`);
                  return;
                }
                const res = await github.rest.pulls.create({ owner, repo, title, head, base, body, maintainer_can_modify: true });
                core.info(`Created PR: ${res.data.html_url}`);
              } catch (err) {
                core.setFailed(`Failed to create PR: ${err.message}`);
              }
            }

            await run();
